version: 0.2

phases:
  pre_build:
    commands:
      - echo "Cloning repository from GitHub..."
      # Token passed via $GITHUB_TOKEN env var (not logged)
      - git clone https://x-access-token:$GITHUB_TOKEN@github.com/{{REPO_PATH}}.git repo
      - cd repo/{{ROOT_DIRECTORY}}
      - echo "Creating Dockerfile for Python..."
      - |
        cat > Dockerfile << 'DOCKERFILE_EOF'
{{DOCKERFILE_CONTENT}}
        DOCKERFILE_EOF
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region {{AWS_REGION}} | docker login --username AWS --password-stdin {{AWS_ACCOUNT_ID}}.dkr.ecr.{{AWS_REGION}}.amazonaws.com
  build:
    commands:
      - echo "Building Docker image..."
      - docker build -t {{ECR_REPO_URI}}:latest .
  post_build:
    commands:
      - echo "Pushing Docker image to ECR..."
      - docker push {{ECR_REPO_URI}}:latest
      - echo "Build completed successfully"
